---
import LargeBaseLayout from "../components/Common/LargeBaseLayout.astro";
import ScheduleCard from "../components/Schedule/ScheduleCard.astro";
import { getSchedule } from "../scripts/api/sessionize_api";

const schedule = await getSchedule();
---

<LargeBaseLayout pageTitle="Schedule">
  {
    schedule.map((s) => {
      const totalScheduleCols = s.rooms.length + 1;
      const totalScheduleRows = s.timeSlots.length;

      return (
        <div class="mb-5">
          <p class="text-3xl font-bold mb-5">
            {new Date(s.date).toLocaleDateString("en-US", {
              day: "numeric",
              month: "long",
              weekday: "long",
            })}
          </p>
          <div
            class={`grid grid-flow-row xl:grid-cols-[90px_repeat(5,_minmax(0,_1fr))] xl:grid-rows-${totalScheduleRows} grid-cols-1 gap-4`}
          >
            {s.timeSlots.map((ts,ts_idx) => {
              const hasServiceSession = ts.rooms.some(
                (tsr) => tsr.session.isServiceSession,
              );
              const sessionsInTimeSlot = ts.rooms.map((tsr) => {
                const endDate = new Date(tsr.session.endsAt);
                endDate.setSeconds(0)
                endDate.setMilliseconds(0)
                const slots = !hasServiceSession? (
                  (()=>{
                    //Calculate the space to take (how many timeSlot takes this session (until a service session))
                    let session_len = 1
                    for (let i = ts_idx+1; i < s.timeSlots.length; i++){
                      //No sessions
                      if (s.timeSlots[i].rooms.length == 0) continue
                      //Take time from one of the sessions
                      const exampleSession = s.timeSlots[i].rooms[0].session
                      //If it's a service session, can't take this space
                      if (exampleSession.isServiceSession){
                        break
                      }
                      //Continue to get space until this session ends
                      const next_date = new Date(exampleSession.startsAt)
                      next_date.setSeconds(0)
                      next_date.setMilliseconds(0)
                      if (next_date < endDate){
                        session_len ++
                      }else{
                        break
                      }
                    }
                    return session_len
                  })()
                ) : 1;

                const colspanClass = `xl:col-span-${
                  hasServiceSession ? totalScheduleCols - 1 : 1
                } row-span-${slots}`;

                return (
                  
                  <div class={colspanClass}>
                    <ScheduleCard value={tsr} />
                  </div>
                );
              });
              sessionsInTimeSlot.unshift(
                <div class="font-medium text-2xl">
                  <p>{ts.slotStart.substring(0, 5)}</p>
                </div>,
              );

              const deltaNumRowsWithtalk = ts_idx== 0? false : s.timeSlots[ts_idx-1].rooms.length - ts.rooms.length;

              if (
              deltaNumRowsWithtalk != 1 && 
                ts.rooms.length + 1 < totalScheduleCols &&
                !hasServiceSession
              ) {
                const placeholder = <div />;
                sessionsInTimeSlot.push(placeholder);
              }

              return sessionsInTimeSlot;
            })}
          </div>
        </div>
      );
    })
  }
</LargeBaseLayout>

